import sqlite3
import pandas as pd
import json
from datetime import datetime

class FahasaDatabase:
    def __init__(self, db_name="fahasa_books.db"):
        self.db_name = db_name
        self.create_database()
    
    def create_database(self):
        """T·∫°o database v√† b·∫£ng theo schema ƒë√£ ƒë·ªãnh"""
        conn = sqlite3.connect(self.db_name)
        cursor = conn.cursor()
        
        # T·∫°o b·∫£ng books v·ªõi ƒë·∫ßy ƒë·ªß c√°c tr∆∞·ªùng
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS books (
                id_book INTEGER PRIMARY KEY AUTOINCREMENT,
                title TEXT,
                author TEXT,
                publisher TEXT,
                supplier TEXT,
                category_1 TEXT,
                category_2 TEXT,
                category_3 TEXT,
                original_price REAL,
                discount_price REAL,
                discount_percent REAL,
                rating REAL,
                rating_count INTEGER,
                sold_count TEXT,
                sold_count_numeric INTEGER,
                publish_year INTEGER,
                language TEXT,
                page_count INTEGER,
                weight REAL,
                dimensions TEXT,
                url TEXT,
                url_img TEXT,
                time_collect DATETIME,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # T·∫°o indexes ƒë·ªÉ t·ªëi ∆∞u t√¨m ki·∫øm
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_title ON books(title)')
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_author ON books(author)')
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_publisher ON books(publisher)')
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_category_1 ON books(category_1)')
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_price ON books(discount_price)')
        cursor.execute('CREATE INDEX IF NOT EXISTS idx_rating ON books(rating)')
        
        conn.commit()
        conn.close()
        
        print(f"‚úÖ ƒê√£ t·∫°o database {self.db_name}")
    
    def url_exists(self, url):
        """Ki·ªÉm tra URL ƒë√£ t·ªìn t·∫°i trong database ch∆∞a"""
        conn = sqlite3.connect(self.db_name)
        cursor = conn.cursor()
        
        cursor.execute("SELECT COUNT(*) FROM books WHERE url = ?", (url,))
        result = cursor.fetchone()[0] > 0
        
        conn.close()
        return result
    
    def close(self):
        """ƒê√≥ng k·∫øt n·ªëi database (placeholder method)"""
        pass
    
    def insert_book(self, book_data):
        """Ch√®n m·ªôt s√°ch v√†o database"""
        if not book_data:
            return False
        
        conn = sqlite3.connect(self.db_name)
        cursor = conn.cursor()
        
        try:
            # Ki·ªÉm tra xem s√°ch ƒë√£ t·ªìn t·∫°i ch∆∞a
            cursor.execute('SELECT id_book FROM books WHERE url = ?', (book_data['url'],))
            existing = cursor.fetchone()
            
            if existing:
                conn.close()
                return False
            
            # Ch√®n d·ªØ li·ªáu m·ªõi
            insert_query = '''
                INSERT INTO books (
                    title, author, publisher, supplier, category_1, category_2, category_3,
                    original_price, discount_price, discount_percent, rating, rating_count,
                    sold_count, sold_count_numeric, publish_year, language, page_count,
                    weight, dimensions, url, url_img, time_collect
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            '''
            
            cursor.execute(insert_query, (
                book_data.get('title', ''),
                book_data.get('author', ''),
                book_data.get('publisher', ''),
                book_data.get('supplier', ''),
                book_data.get('category_1', ''),
                book_data.get('category_2', ''),
                book_data.get('category_3', ''),
                book_data.get('original_price', 0.0),
                book_data.get('discount_price', 0.0),
                book_data.get('discount_percent', 0.0),
                book_data.get('rating', 0.0),
                book_data.get('rating_count', 0),
                book_data.get('sold_count', ''),
                book_data.get('sold_count_numeric', 0),
                book_data.get('publish_year', 0),
                book_data.get('language', ''),
                book_data.get('page_count', 0),
                book_data.get('weight', 0.0),
                book_data.get('dimensions', ''),
                book_data.get('url', ''),
                book_data.get('url_img', ''),
                book_data.get('time_collect', '')
            ))
            
            conn.commit()
            conn.close()
            return True
            
        except Exception as e:
            conn.close()
            print(f"‚ùå L·ªói insert book: {e}")
            return False
    
    def insert_books(self, books_data):
        """Ch√®n d·ªØ li·ªáu s√°ch v√†o database"""
        if not books_data:
            print("‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ch√®n")
            return 0
        
        conn = sqlite3.connect(self.db_name)
        cursor = conn.cursor()
        
        insert_query = '''
            INSERT INTO books (
                title, author, publisher, supplier, category_1, category_2, category_3,
                original_price, discount_price, discount_percent, rating, rating_count,
                sold_count, sold_count_numeric, publish_year, language, page_count,
                weight, dimensions, url, url_img, time_collect
            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        '''
        
        inserted_count = 0
        
        for book in books_data:
            try:
                # Ki·ªÉm tra xem s√°ch ƒë√£ t·ªìn t·∫°i ch∆∞a (d·ª±a v√†o URL)
                cursor.execute('SELECT id_book FROM books WHERE url = ?', (book['url'],))
                existing = cursor.fetchone()
                
                if existing:
                    print(f"‚ö†Ô∏è S√°ch ƒë√£ t·ªìn t·∫°i: {book['title']}")
                    continue
                
                # Ch√®n d·ªØ li·ªáu m·ªõi
                cursor.execute(insert_query, (
                    book.get('title', ''),
                    book.get('author', ''),
                    book.get('publisher', ''),
                    book.get('supplier', ''),
                    book.get('category_1', ''),
                    book.get('category_2', ''),
                    book.get('category_3', ''),
                    book.get('original_price', 0.0),
                    book.get('discount_price', 0.0),
                    book.get('discount_percent', 0.0),
                    book.get('rating', 0.0),
                    book.get('rating_count', 0),
                    book.get('sold_count', ''),
                    book.get('sold_count_numeric', 0),
                    book.get('publish_year', 0),
                    book.get('language', ''),
                    book.get('page_count', 0),
                    book.get('weight', 0.0),
                    book.get('dimensions', ''),
                    book.get('url', ''),
                    book.get('url_img', ''),
                    book.get('time_collect', '')
                ))
                
                inserted_count += 1
                print(f"‚úÖ ƒê√£ ch√®n: {book.get('title', 'Unknown')}")
                
            except Exception as e:
                print(f"‚ùå L·ªói ch√®n s√°ch {book.get('title', 'Unknown')}: {e}")
        
        conn.commit()
        conn.close()
        
        print(f"üéâ ƒê√£ ch√®n th√†nh c√¥ng {inserted_count} s√°ch v√†o database")
        return inserted_count
    
    def get_statistics(self):
        """L·∫•y th·ªëng k√™ database"""
        conn = sqlite3.connect(self.db_name)
        cursor = conn.cursor()
        
        stats = {}
        
        # T·ªïng s·ªë s√°ch
        cursor.execute('SELECT COUNT(*) FROM books')
        stats['total_books'] = cursor.fetchone()[0]
        
        # S·ªë s√°ch c√≥ gi√°
        cursor.execute('SELECT COUNT(*) FROM books WHERE discount_price > 0 OR original_price > 0')
        stats['books_with_price'] = cursor.fetchone()[0]
        
        # S·ªë s√°ch c√≥ t√°c gi·∫£
        cursor.execute('SELECT COUNT(*) FROM books WHERE author != ""')
        stats['books_with_author'] = cursor.fetchone()[0]
        
        # S·ªë s√°ch c√≥ nh√† xu·∫•t b·∫£n
        cursor.execute('SELECT COUNT(*) FROM books WHERE publisher != ""')
        stats['books_with_publisher'] = cursor.fetchone()[0]
        
        # Gi√° trung b√¨nh
        cursor.execute('SELECT AVG(CASE WHEN discount_price > 0 THEN discount_price ELSE original_price END) FROM books WHERE discount_price > 0 OR original_price > 0')
        avg_price = cursor.fetchone()[0]
        stats['average_price'] = round(avg_price, 0) if avg_price else 0
        
        # Top 5 danh m·ª•c
        cursor.execute('SELECT category_1, COUNT(*) as count FROM books WHERE category_1 != "" GROUP BY category_1 ORDER BY count DESC LIMIT 5')
        stats['top_categories'] = cursor.fetchall()
        
        # Top 5 nh√† xu·∫•t b·∫£n
        cursor.execute('SELECT publisher, COUNT(*) as count FROM books WHERE publisher != "" GROUP BY publisher ORDER BY count DESC LIMIT 5')
        stats['top_publishers'] = cursor.fetchall()
        
        conn.close()
        
        return stats
    
    def export_to_excel(self, filename=None):
        """Xu·∫•t d·ªØ li·ªáu ra file Excel"""
        if not filename:
            filename = f"fahasa_books_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
        
        conn = sqlite3.connect(self.db_name)
        
        # ƒê·ªçc d·ªØ li·ªáu
        df = pd.read_sql_query('SELECT * FROM books ORDER BY created_at DESC', conn)
        
        # T·∫°o Excel v·ªõi nhi·ªÅu sheet
        with pd.ExcelWriter(filename, engine='openpyxl') as writer:
            # Sheet ch√≠nh
            df.to_excel(writer, sheet_name='Books', index=False)
            
            # Sheet th·ªëng k√™ theo danh m·ª•c
            category_stats = pd.read_sql_query('''
                SELECT category_1, COUNT(*) as total_books, 
                       AVG(CASE WHEN discount_price > 0 THEN discount_price ELSE original_price END) as avg_price,
                       AVG(rating) as avg_rating
                FROM books 
                WHERE category_1 != "" 
                GROUP BY category_1 
                ORDER BY total_books DESC
            ''', conn)
            category_stats.to_excel(writer, sheet_name='Category_Stats', index=False)
            
            # Sheet th·ªëng k√™ theo nh√† xu·∫•t b·∫£n
            publisher_stats = pd.read_sql_query('''
                SELECT publisher, COUNT(*) as total_books,
                       AVG(CASE WHEN discount_price > 0 THEN discount_price ELSE original_price END) as avg_price
                FROM books 
                WHERE publisher != "" 
                GROUP BY publisher 
                ORDER BY total_books DESC
                LIMIT 20
            ''', conn)
            publisher_stats.to_excel(writer, sheet_name='Publisher_Stats', index=False)
        
        conn.close()
        
        print(f"üìä ƒê√£ xu·∫•t d·ªØ li·ªáu ra file {filename}")
        return filename
    
    def search_books(self, keyword="", category="", min_price=0, max_price=999999999, min_rating=0):
        """T√¨m ki·∫øm s√°ch"""
        conn = sqlite3.connect(self.db_name)
        
        query = '''
            SELECT title, author, publisher, category_1, 
                   CASE WHEN discount_price > 0 THEN discount_price ELSE original_price END as price,
                   rating, url
            FROM books 
            WHERE 1=1
        '''
        params = []
        
        if keyword:
            query += ' AND (title LIKE ? OR author LIKE ? OR publisher LIKE ?)'
            keyword_pattern = f'%{keyword}%'
            params.extend([keyword_pattern, keyword_pattern, keyword_pattern])
        
        if category:
            query += ' AND category_1 LIKE ?'
            params.append(f'%{category}%')
        
        if min_price > 0:
            query += ' AND (discount_price >= ? OR (discount_price = 0 AND original_price >= ?))'
            params.extend([min_price, min_price])
        
        if max_price < 999999999:
            query += ' AND (discount_price <= ? OR (discount_price = 0 AND original_price <= ?))'
            params.extend([max_price, max_price])
        
        if min_rating > 0:
            query += ' AND rating >= ?'
            params.append(min_rating)
        
        query += ' ORDER BY rating DESC, price ASC LIMIT 50'
        
        df = pd.read_sql_query(query, conn, params=params)
        conn.close()
        
        return df

def load_json_to_database(json_file, db_name="fahasa_books.db"):
    """Load d·ªØ li·ªáu t·ª´ file JSON v√†o database"""
    try:
        with open(json_file, 'r', encoding='utf-8') as f:
            books_data = json.load(f)
        
        db = FahasaDatabase(db_name)
        inserted = db.insert_books(books_data)
        
        print(f"‚úÖ ƒê√£ load {inserted} s√°ch t·ª´ {json_file} v√†o database")
        
        # Hi·ªÉn th·ªã th·ªëng k√™
        stats = db.get_statistics()
        print(f"\nüìä Th·ªëng k√™ database:")
        print(f"- T·ªïng s·ªë s√°ch: {stats['total_books']}")
        print(f"- S√°ch c√≥ gi√°: {stats['books_with_price']}")
        print(f"- Gi√° trung b√¨nh: {stats['average_price']:,.0f} VNƒê")
        
        return db
        
    except Exception as e:
        print(f"‚ùå L·ªói load JSON: {e}")
        return None

def main():
    """Demo s·ª≠ d·ª•ng database"""
    db = FahasaDatabase()
    
    # V√≠ d·ª• t√¨m ki·∫øm
    print("üîç T√¨m ki·∫øm s√°ch c√≥ t·ª´ 'vƒÉn h·ªçc':")
    results = db.search_books(keyword="vƒÉn h·ªçc")
    print(results.head())
    
    # Xu·∫•t Excel
    excel_file = db.export_to_excel()
    print(f"üìä ƒê√£ t·∫°o file Excel: {excel_file}")

if __name__ == "__main__":
    main()